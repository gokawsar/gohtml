<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GUB | Semester Planner</title>
  <style>
    :root{
      --bg:#0e1116; --panel:#151a22; --muted:#8ba0b3; --text:#e5edf5; --accent:#50b5ff; --danger:#ff6b6b; --ok:#38d39f; --chip:#233142;
      --grid-border:#2a3442; --slot-bg:#10151c; --break-bg:#0b1118; --offered-chip:#1b2531;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Roboto,system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}

    /* Top bar */
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid var(--grid-border);background:#10161e;gap:14px;flex-wrap:wrap}
    .topbar h1{margin:0;font-size:15px;font-weight:600;letter-spacing:.3px}
    .topbar .slots{font-size:11px;color:var(--muted)}
    .top-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid var(--grid-border);background:#0f141b;color:var(--text);cursor:pointer;font-size:12px}
    .btn.primary{background:var(--accent);border-color:transparent;color:#04131f;font-weight:600}
    .btn.small{padding:4px 8px;font-size:11px}

    /* New narrow widths for day & break columns */
    th.day-col{width:60px;}
    td.break-cell, th.break-col{width:88px;}
    td.break-cell{padding:4px;font-size:11px}
    td.break-cell.evening{background:#12161d;color:#98a8b8}

    /* Workspace layout: schedule + summary on right */
    .workspace{display:flex;align-items:flex-start;gap:14px;padding:14px}
    .scheduler{flex:1;background:var(--panel);border:1px solid var(--grid-border);border-radius:10px;overflow:visible;min-height:70vh;position:relative}

    /* Summary panel moved to right */
    #summaryPanel{width:300px;flex:0 0 300px;display:flex;flex-direction:column;gap:12px;background:var(--panel);border:1px solid var(--grid-border);border-radius:10px;padding:12px;position:sticky;top:8px;max-height:calc(100vh - 24px);overflow:auto}
    #headerSummary{display:flex;flex-direction:column;gap:4px;font-size:11px}
    #headerSummary .sel-line{display:flex;flex-wrap:wrap;gap:4px}
    #headerSummary .label{font-weight:600;color:var(--accent)}
    .chip-mini{background:#1b2531;border:1px solid #2a3a4a;padding:2px 6px;border-radius:999px;font-size:10px;line-height:1;display:inline-flex;gap:4px;align-items:center;color:#c9d7e6}
    .chip-mini sup{font-size:8px;font-weight:600;margin-left:2px;color:var(--muted)}

    .summary-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:6px}
    .summary-item{border:1px solid var(--grid-border);background:#0f141b;border-radius:6px;padding:6px}
    .summary-item .title{font-size:11px;font-weight:600}
    .summary-item .meta{font-size:10px;color:var(--muted)}
    .credits-box{margin-top:4px;font-size:12px;font-weight:600}

    .legend{display:flex;gap:10px;align-items:center;padding:8px 10px;border-bottom:1px solid var(--grid-border);font-size:11px}
    .legend .dot{width:10px;height:10px;border-radius:50%}

    table{width:100%;border-collapse:collapse;table-layout:fixed}
    thead th{position:sticky;top:0;background:#0f141b;z-index:2}
    th,td{border:1px solid var(--grid-border);padding:8px;vertical-align:top}
    th{font-size:12px;color:#c9d7e6}
    td{background:var(--slot-bg)}
    .break-cell{background:var(--break-bg);text-align:center;color:var(--muted);font-weight:600}

    .cell{display:flex;flex-direction:column;gap:6px}
    .selected-list{display:flex;flex-direction:column;gap:6px}
    .selected{border-left:4px solid var(--accent);background:#0e1520;padding:6px;border-radius:8px}
    .selected .head{display:flex;justify-content:space-between;gap:8px;font-size:12px}
    .selected .sub{font-size:11px;color:var(--muted)}
    .remove{cursor:pointer;background:transparent;border:1px solid #3a4657;color:#c9d7e6;border-radius:6px;padding:2px 6px;font-size:11px}

    /* Dropdown options */
    .options{position:relative;align-self:flex-start}
    .options-btn{padding:4px 8px;border-radius:8px;border:1px solid var(--grid-border);background:#0f141b;color:var(--text);font-size:11px;cursor:pointer}
    .options-btn:disabled{opacity:.35;cursor:not-allowed}
    .options-menu{position:absolute;inset:auto auto auto 0;top:calc(100% + 4px);min-width:260px;max-width:430px;max-height:300px;overflow:auto;z-index:1000;background:#0f141b;border:1px solid var(--grid-border);border-radius:8px;box-shadow:0 8px 20px rgba(0,0,0,.45);display:none;overscroll-behavior:contain;-webkit-overflow-scrolling:touch}
    .options.open .options-menu{display:block}
    .options-menu.drop-up{top:auto;bottom:calc(100% + 4px)}
    .options-menu.align-right{left:auto;right:0}
    .option-item{display:flex;gap:8px;padding:8px;border-bottom:1px solid #1f2732;cursor:pointer}
    .option-item:last-child{border-bottom:none}
    .option-item:hover{background:#12202e}
    .option-dot{width:10px;height:10px;border-radius:50%;margin-top:4px;flex:0 0 10px}
    .option-title{font-size:12px;font-weight:600}
    .option-meta{font-size:11px;color:var(--muted);line-height:1.3}

    .selected-list.glow{outline:2px solid var(--accent); outline-offset:-2px; background:#0f1a24}

    /* Modal for course finder */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-start;justify-content:center;z-index:2000;padding:40px 18px 24px;overflow:auto}
    .modal-overlay.open{display:flex}
    .modal{background:var(--panel);border:1px solid var(--grid-border);border-radius:12px;max-width:900px;width:100%;display:flex;flex-direction:column;max-height:100%;}
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--grid-border);background:#111821}
    .modal header h2{margin:0;font-size:15px;font-weight:600}
    .modal .body{display:grid;grid-template-columns:300px 1fr;gap:12px;padding:14px;overflow:hidden}
    .modal .filters{display:flex;flex-direction:column;gap:12px}
    .panel-section{border:1px solid var(--grid-border);padding:10px;border-radius:10px}
    .panel-section label{display:block;font-size:11px;color:var(--muted);margin-bottom:4px}
    .panel-section input,.panel-section select{width:100%;padding:6px 7px;border-radius:6px;border:1px solid var(--grid-border);background:#0f141b;color:var(--text);font-size:12px}
    .panel-section .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .results{flex:1;overflow:auto;padding:0 4px}
    .card{border:1px solid var(--grid-border);background:#0f141b;border-radius:10px;padding:10px;margin-bottom:10px}
    .card .title{font-size:14px;font-weight:600;margin-bottom:4px}
    .card .actions{display:flex;gap:8px;margin-top:6px}

    .notice{padding:8px 10px;background:#10202b;border-left:3px solid var(--accent);border-radius:8px;color:#cfe9ff;font-size:11px}
    .error{padding:8px 10px;background:#2a1215;border-left:3px solid var(--danger);border-radius:8px;color:#ffc7cc;font-size:12px;margin:8px 0}

    .muted{color:var(--muted)}
    .hidden{display:none !important}

    @media (max-width:1000px){
      .workspace{flex-direction:column}
      #summaryPanel{width:100%;order:-1;flex:auto;position:static}
      .modal .body{grid-template-columns:1fr}
      .topbar{position:sticky;top:0;z-index:1500}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Semester Planner</h1>
    <div class="slots">Slots: 08:30–10:00 | 10:00–11:30 | 11:30–13:00 | Break | 13:30–15:00 | 15:00–16:30 | Evening Break | 18:00–19:30 | 19:30–21:00</div>
    <div class="top-actions">
      <button class="btn small" id="openFinder">Course Finder</button>
      <button class="btn small" id="exportSelection">Export</button>
      <button class="btn small" id="clearSelection">Clear</button>
      <span id="dataMeta" class="muted" style="font-size:11px">Loading…</span>
    </div>
  </div>

  <div class="workspace">
    <main class="scheduler">
      <div class="legend">
        <div class="dot" style="background: var(--accent)"></div><span>Selected</span>
        <div class="dot" style="background: var(--offered-chip);margin-left:12px"></div><span>Available (Options)</span>
        <div class="dot" style="background: var(--danger);margin-left:12px;opacity:.7"></div><span>Conflict (prevented)</span>
      </div>
      <div class="error hidden" id="loadError">Failed to load ClassRoutine-DM.json. Serve over HTTP & ensure valid JSON array.</div>
      <div class="table-wrap"><table id="scheduleTable"></table></div>
    </main>
    <aside id="summaryPanel">
      <h3 style="margin:0 0 6px;font-size:14px">Selected Summary</h3>
      <div id="headerSummary"><div class="muted" style="font-size:11px">No selection</div></div>
      <div class="credits-box">Credits: <span id="creditCount">0</span></div>
      <div class="small muted" id="summaryMeta">No courses selected</div>
      <div class="small" style="margin:6px 0 4px;font-weight:600;color:var(--accent)">Theory</div>
      <div class="summary-grid" id="summaryTheory"></div>
      <div class="small" style="margin:8px 0 4px;font-weight:600;color:var(--accent)">Lab</div>
      <div class="summary-grid" id="summaryLab"></div>
      <button class="btn primary" id="openFinder2" style="margin-top:10px">Add / Search Courses</button>
    </aside>
  </div>

  <!-- Modal Finder -->
  <div class="modal-overlay" id="courseModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="finderTitle">
      <header>
        <h2 id="finderTitle">Find & Select Courses</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="muted" id="resultsMeta" style="font-size:11px">0 matching sections</div>
          <button class="btn small" id="closeFinder" aria-label="Close">Close</button>
        </div>
      </header>
      <div class="body">
        <div class="filters">
          <div class="panel-section">
            <div class="row">
              <div>
                <label for="programFilter">Program</label>
                <select id="programFilter"><option value="">All</option></select>
              </div>
              <div>
                <label for="batchFilter">Batch</label>
                <select id="batchFilter"><option value="">All</option></select>
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <div>
                <label for="typeFilter">Type</label>
                <select id="typeFilter"><option value="">All</option><option value="Theory">Theory</option><option value="Lab">Lab</option></select>
              </div>
              <div>
                <label for="dayFilter">Day</label>
                <select id="dayFilter"><option value="">Any</option><option>Sat</option><option>Sun</option><option>Mon</option><option>Tue</option><option>Wed</option><option>Thu</option></select>
              </div>
            </div>
            <div class="row" style="margin-top:8px">
              <div>
                <label for="codeFilter">Course code</label>
                <input id="codeFilter" placeholder="e.g., CSE 211" />
              </div>
              <div>
                <label for="titleFilter">Title/Teacher</label>
                <input id="titleFilter" placeholder="title or teacher" />
              </div>
            </div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button class="btn primary" id="applyFilters">Search</button>
              <button class="btn" id="resetFilters">Reset</button>
            </div>
          </div>
          <div class="notice">Click a card or choose a time-slot Options dropdown. Hover a theory section to highlight its other day.</div>
        </div>
        <div class="results" id="results"></div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // Constants
    const DAYS = ['Sat','Sun','Mon','Tue','Wed','Thu'];
    const SLOT_DEFS = [
      { key:'S1', label:'08:30 AM - 10:00 AM', start:'08:30', end:'10:00' },
      { key:'S2', label:'10:00 AM - 11:30 AM', start:'10:00', end:'11:30' },
      { key:'S3', label:'11:30 AM - 01:00 PM', start:'11:30', end:'13:00' },
      { key:'BREAK', label:'Break', isBreak:true, start:'13:00', end:'13:30' },
      { key:'S4', label:'01:30 PM - 03:00 PM', start:'13:30', end:'15:00' },
      { key:'S5', label:'03:00 PM - 04:30 PM', start:'15:00', end:'16:30' },
      /* Newly added evening break slot */
      { key:'EBREAK', label:'Evening Break', isBreak:true, start:'16:30', end:'18:00' },
      { key:'S6', label:'06:00 PM - 07:30 PM', start:'18:00', end:'19:30' },
      { key:'S7', label:'07:30 PM - 09:00 PM', start:'19:30', end:'21:00' }
    ];

    // State
    const state = { all: [], offeredIndex:{}, selected:new Map(), selectedSlots:{}, filters:{ program:'', batch:'', type:'', day:'', code:'', text:'' } };
    let glowTargets = [];

    // Utilities
    function toMinutes(hhmm){ if(!hhmm) return null; let s=hhmm.trim(); const ampmMatch=s.match(/([0-9]{1,2})[:\. ]?([0-9]{2})?\s*:?(AM|PM)/i); if(ampmMatch){ let h=parseInt(ampmMatch[1],10); let m=parseInt(ampmMatch[2]||'0',10); const ap=ampmMatch[3].toUpperCase(); if(ap==='PM' && h!==12) h+=12; if(ap==='AM' && h===12) h=0; return h*60+m;} const m2=s.match(/^(\d{1,2}):(\d{2})$/); if(m2) return parseInt(m2[1],10)*60+parseInt(m2[2],10); return null; }
    function parseRange(range){ if(!range||typeof range!=='string') return null; const parts=range.split('-'); if(parts.length<2) return null; const start=toMinutes(parts[0].replace(/\s+/g,'').replace(/\./g,':')); const end=toMinutes(parts[1].replace(/\s+/g,'').replace(/\./g,':')); if(start==null||end==null) return null; return {start,end}; }
    function capDay(d){ if(!d) return ''; const s=d.trim(); return s.charAt(0).toUpperCase()+s.slice(1,3).toLowerCase(); }
    function hashColor(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0;} const hue=Math.abs(h)%360; return `hsl(${hue} 70% 45%)`; }
    function toHHMM(m){ const h=Math.floor(m/60), mm=m%60; const ap=h>=12?'PM':'AM'; const h12=((h+11)%12)+1; return `${String(h12).padStart(2,'0')}:${String(mm).padStart(2,'0')} ${ap}`; }
    function formatRange(s,e){ return toHHMM(s)+' - '+toHHMM(e); }
    function overlapSlots(start,end,isLab){ const idxs=[]; SLOT_DEFS.forEach((sl,i)=>{ if(sl.isBreak) return; const sm=toMinutes(sl.start), em=toMinutes(sl.end); const oStart=Math.max(start,sm); const oEnd=Math.min(end,em); if(Math.max(0,oEnd-oStart)>=30) idxs.push(i); }); if(isLab && idxs.length===1){ const dur=end-start; if(dur>=110){ const i=idxs[0]; if(i+1<SLOT_DEFS.length) idxs.push(i+1);} } return Array.from(new Set(idxs)).sort((a,b)=>a-b); }

    function normalize(raw){ try{ const title=raw.Title?.trim(); const formal=raw['FormalCode']?.toString().trim(); const section=raw['SectionName']?.toString().trim(); const credits=Number(raw.Credits); if(!title||!formal||!section||!Number.isFinite(credits)) return null; const type=/(lab)/i.test(raw.GradeSheetTemplate||'')?'Lab':'Theory'; const dayTimes=[]; const d1=capDay(raw.Day1||''); const t1=raw['Time1 (On Day 1)']?.trim(); if(d1 && t1 && t1!=='-'){ const r1=parseRange(t1); if(r1) dayTimes.push({ day:d1, start:r1.start, end:r1.end, room:(raw['Room1 (On Day 1)']||'').trim(), building:(raw['Building1 (On Day 1)']||'').trim(), teacher:(raw['Teacher1 (On Day 1)']||'').trim() }); }
      if(type==='Theory'){ const d2=capDay(raw.Day2||''); const t2=raw['Time2 (On Day 2)']?.trim(); if(d2 && t2 && t2!=='-'){ const r2=parseRange(t2); if(r2) dayTimes.push({ day:d2, start:r2.start, end:r2.end, room:(raw['Room2 (On Day 2)']||raw['Room2 (On Day 1)']||'').trim(), building:(raw['Building2 (On Day 2)']||'').trim(), teacher:(raw['Teacher2 (On Day 2)']||raw['Teacher2 (On Day 1)']||'').trim() }); } }
      if(!dayTimes.length) return null; const code=formal.split(/\s*-/)[0].trim(); const id=`${formal}|${section}`; return { id, code,title,section, program:raw.Program?.trim()||'', batch:raw.Batch?.trim()||'', credits, type, dayTimes, teachers:Array.from(new Set([raw['Teacher1 (On Day 1)'],raw['Teacher2 (On Day 2)']].filter(Boolean))).map(s=>s?.toString().trim()) }; }catch{ return null; }}

    function buildOfferedIndex(){ state.offeredIndex={}; DAYS.forEach(d=> state.offeredIndex[d]=SLOT_DEFS.map(()=>[])); state.all.forEach(sec=>{ sec.dayTimes.forEach(dt=>{ overlapSlots(dt.start,dt.end,sec.type==='Lab').forEach(si=>{ if(!state.offeredIndex[dt.day]) state.offeredIndex[dt.day]=SLOT_DEFS.map(()=>[]); state.offeredIndex[dt.day][si].push(sec.id); }); }); }); }

    function selectedCourseCodes(){ const set=new Set(); state.selected.forEach(s=> set.add(s.code)); return set; }
    function getAvailableIds(day,sidx){ const ids=(state.offeredIndex[day]?.[sidx])||[]; if(!ids.length) return ids; const taken=selectedCourseCodes(); return ids.filter(id=>{ const sec=state.allMap.get(id); if(!sec) return false; if(taken.has(sec.code)) return false; return true; }); }

    function renderTable(){ const table=document.getElementById('scheduleTable'); const thead=document.createElement('thead'); const trh=document.createElement('tr'); const thd=document.createElement('th'); thd.textContent='Day'; thd.className='day-col'; trh.appendChild(thd); SLOT_DEFS.forEach(sl=>{ const th=document.createElement('th'); th.textContent=sl.label; if(sl.isBreak) th.classList.add('break-col'); trh.appendChild(th);}); thead.appendChild(trh); const tbody=document.createElement('tbody'); DAYS.forEach(day=>{ const tr=document.createElement('tr'); const h=document.createElement('th'); h.textContent=day; tr.appendChild(h); SLOT_DEFS.forEach((sl,sidx)=>{ const td=document.createElement('td'); if(sl.isBreak){ td.className='break-cell'+(sl.key==='EBREAK'?' evening':''); td.textContent= sl.key==='EBREAK' ? 'Evening Break' : 'Break'; tr.appendChild(td); return;} const cell=document.createElement('div'); cell.className='cell'; const slist=document.createElement('div'); slist.className='selected-list'; slist.dataset.day=day; slist.dataset.slot=sidx; const options=document.createElement('div'); options.className='options'; const btn=document.createElement('button'); btn.className='options-btn'; btn.dataset.day=day; btn.dataset.slot=sidx; const count=getAvailableIds(day,sidx).length; btn.textContent=`Options${count?` (${count})`:''}`; if(!count) btn.disabled=true; const menu=document.createElement('div'); menu.className='options-menu'; options.appendChild(btn); options.appendChild(menu); menu.addEventListener('click',e=> e.stopPropagation()); menu.addEventListener('mousedown',e=> e.stopPropagation()); menu.addEventListener('wheel',e=> e.stopPropagation(),{passive:true}); btn.addEventListener('click',e=>{ e.stopPropagation(); if(btn.disabled) return; const will=!options.classList.contains('open'); closeAllMenus(); if(will){ options.classList.add('open'); buildOptionsMenu(menu,day,sidx); positionOptionsMenu(options,menu); setTimeout(()=> menu.querySelector('.option-item')?.focus(),0);} }); cell.appendChild(slist); cell.appendChild(options); td.appendChild(cell); tr.appendChild(td); }); tbody.appendChild(tr); }); table.innerHTML=''; table.appendChild(thead); table.appendChild(tbody); document.addEventListener('click',closeAllMenus,{once:false}); window.addEventListener('resize',closeAllMenus); }

    function updateOptionCounts(){ document.querySelectorAll('.options-btn').forEach(btn=>{ const day=btn.dataset.day; const slot=parseInt(btn.dataset.slot,10); const c=getAvailableIds(day,slot).length; btn.textContent=`Options${c?` (${c})`:''}`; btn.disabled=!c; }); }

    function chipTitle(sec,day){ const dt=sec.dayTimes.find(x=>x.day===day); const timeHere=dt?formatRange(dt.start,dt.end):''; const other=sec.dayTimes.find(x=>x.day!==day); const otherTxt=other?`${other.day} ${formatRange(other.start,other.end)}`:(sec.type==='Lab'?'Lab (single day)':''); return `${sec.code} ${sec.section}\n${sec.title}\nHere: ${day} ${timeHere}${otherTxt?`\nOther: ${otherTxt}`:''}\nTeacher: ${(sec.teachers||[]).join(', ')}`.trim(); }

    function buildOptionsMenu(menu,day,sidx){ menu.innerHTML=''; const ids=getAvailableIds(day,sidx); if(!ids.length){ const empty=document.createElement('div'); empty.className='option-meta'; empty.style.padding='8px'; empty.textContent='No sections (course selected)'; menu.appendChild(empty); return;} ids.slice(0,250).forEach((id,idx)=>{ const sec=state.allMap.get(id); if(!sec) return; const color=hashColor(sec.code); const item=document.createElement('div'); item.className='option-item'; item.title=chipTitle(sec,day); item.tabIndex=0; const dot=document.createElement('div'); dot.className='option-dot'; dot.style.background=color; const body=document.createElement('div'); body.style.flex='1'; const here=sec.dayTimes.find(x=>x.day===day); const other=sec.dayTimes.find(x=>x.day!==day); const hereStr=here?`${day} ${formatRange(here.start,here.end)} ${here.building||''}${here.room?'-'+here.room:''}`:''; const otherStr=other?`Other: ${other.day} ${formatRange(other.start,other.end)}`:(sec.type==='Lab'?'Lab • single day':''); const tNames=(sec.teachers||[]).join(', '); body.innerHTML = `<div class="option-title">${sec.code} ${sec.section}</div><div class="option-meta">${sec.title}</div><div class="option-meta">${hereStr}${otherStr?` • ${otherStr}`:''}</div><div class="option-meta" style="color:#b2c6d8">${tNames}</div>`; item.appendChild(dot); item.appendChild(body); const showGlow=()=> highlightOtherDay(sec,day); item.addEventListener('mouseenter',showGlow); item.addEventListener('mouseleave',clearGlow); item.addEventListener('focus',showGlow); item.addEventListener('blur',clearGlow); item.addEventListener('touchstart',showGlow,{passive:true}); item.addEventListener('click',()=>{ trySelect(sec); closeAllMenus(); }); item.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); trySelect(sec); closeAllMenus(); } else if(e.key==='ArrowDown'){ e.preventDefault(); (item.nextElementSibling||menu.firstElementChild)?.focus(); } else if(e.key==='ArrowUp'){ e.preventDefault(); (item.previousElementSibling||menu.lastElementChild)?.focus(); } else if(e.key==='Escape'){ closeAllMenus(); } }); menu.appendChild(item); }); }

    function positionOptionsMenu(container,menu){ menu.classList.remove('drop-up','align-right'); menu.style.left=''; menu.style.right=''; menu.style.top=''; menu.style.bottom=''; const r=menu.getBoundingClientRect(); const vw=window.innerWidth, vh=window.innerHeight; if(r.right > vw-12) menu.classList.add('align-right'); if(r.bottom > vh-12) menu.classList.add('drop-up'); }
    function closeAllMenus(){ document.querySelectorAll('.options.open').forEach(el=> el.classList.remove('open')); clearGlow(); }

    function highlightOtherDay(sec,hoveredDay){ clearGlow(); const here=sec.dayTimes.find(x=>x.day===hoveredDay); if(here){ overlapSlots(here.start,here.end,sec.type==='Lab').forEach(si=>{ const el=document.querySelector(`.selected-list[data-day="${hoveredDay}"][data-slot="${si}"]`); if(el){ el.classList.add('glow'); glowTargets.push(el);} }); } if(sec.type==='Theory'){ const other=sec.dayTimes.find(x=>x.day!==hoveredDay); if(other){ overlapSlots(other.start,other.end,false).forEach(si=>{ const el=document.querySelector(`.selected-list[data-day="${other.day}"][data-slot="${si}"]`); if(el){ el.classList.add('glow'); glowTargets.push(el);} }); } } }
    function clearGlow(){ glowTargets.forEach(el=> el.classList.remove('glow')); glowTargets=[]; }

    function renderSelected(){ state.selectedSlots={}; DAYS.forEach(d=> state.selectedSlots[d]=SLOT_DEFS.map(()=>null)); document.querySelectorAll('.selected-list').forEach(el=> el.innerHTML=''); state.selected.forEach(sec=>{ sec.dayTimes.forEach(dt=>{ overlapSlots(dt.start,dt.end,sec.type==='Lab').forEach(si=>{ const cell=document.querySelector(`.selected-list[data-day="${dt.day}"][data-slot="${si}"]`); if(!cell) return; state.selectedSlots[dt.day][si]=state.selectedSlots[dt.day][si]||[]; state.selectedSlots[dt.day][si].push(sec.id); const block=document.createElement('div'); block.className='selected'; const color=hashColor(sec.code); block.style.borderLeftColor=color; block.innerHTML=`<div class="head"><div><strong>${sec.code}</strong> ${sec.section}</div><button class="remove" title="Remove">×</button></div><div class="sub">${sec.title}</div><div class="sub">${dt.day} ${formatRange(dt.start,dt.end)}</div>`; block.querySelector('.remove').addEventListener('click',()=> removeSelection(sec.id)); cell.appendChild(block); }); }); }); let credits=0; const theory=[], lab=[]; state.selected.forEach(s=>{ credits+=(Number(s.credits)||0); (s.type==='Lab'?lab:theory).push(s); }); const cc=document.getElementById('creditCount'); if(cc) cc.textContent=credits; renderSummary(theory,lab); updateHeaderSummary(theory,lab,credits); updateOptionCounts(); }
    function renderSummary(theory,lab){ const tEl=document.getElementById('summaryTheory'); const lEl=document.getElementById('summaryLab'); const mEl=document.getElementById('summaryMeta'); if(!tEl||!lEl||!mEl) return; const make=s=>`<div class="summary-item"><div class="title">${s.code}</div><div class="meta">${s.title}</div><div class="meta">${s.credits} cr • ${s.section}</div></div>`; tEl.innerHTML=theory.map(make).join(''); lEl.innerHTML=lab.map(make).join(''); mEl.textContent=(theory.length+lab.length)?`${theory.length} theory • ${lab.length} lab`:'No courses selected'; }
    function updateHeaderSummary(theory,lab,credits){ const el=document.getElementById('headerSummary'); if(!el) return; if(!theory.length && !lab.length){ el.innerHTML='<div class="muted" style="font-size:11px">No selection</div>'; return;} const tCredits=theory.reduce((a,s)=>a+(Number(s.credits)||0),0); const lCredits=lab.reduce((a,s)=>a+(Number(s.credits)||0),0); const makeChip=s=>`<span class="chip-mini" title="${s.title.replace(/"/g,'&quot;')}">${s.code}<sup>${s.credits}</sup></span>`; el.innerHTML=`<div style="font-size:11px"><strong>${credits} cr</strong> — Theory ${tCredits} / Lab ${lCredits}</div>${theory.length?`<div class=\"sel-line\"><span class=\"label\">T:</span>${theory.map(makeChip).join('')}</div>`:''}${lab.length?`<div class=\"sel-line\"><span class=\"label\">L:</span>${lab.map(makeChip).join('')}</div>`:''}`; }

    function passFilters(sec){ const f=state.filters; if(f.program && sec.program!==f.program) return false; if(f.batch && sec.batch!==f.batch) return false; if(f.type && sec.type!==f.type) return false; if(f.day && !sec.dayTimes.some(dt=>dt.day===f.day)) return false; if(f.code && !(sec.code.toLowerCase().includes(f.code) || sec.id.toLowerCase().includes(f.code))) return false; if(f.text){ const t=[sec.title,...(sec.teachers||[])].join(' ').toLowerCase(); if(!t.includes(f.text)) return false; } return true; }
    function applyFiltersFromUI(){ state.filters.program=document.getElementById('programFilter')?.value||''; state.filters.batch=document.getElementById('batchFilter')?.value||''; state.filters.type=document.getElementById('typeFilter')?.value||''; state.filters.day=document.getElementById('dayFilter')?.value||''; state.filters.code=(document.getElementById('codeFilter')?.value||'').trim().toLowerCase(); state.filters.text=(document.getElementById('titleFilter')?.value||'').trim().toLowerCase(); refreshResults(); }

    function hasConflict(sec){ const conflicts=[]; state.selected.forEach(s2=>{ if(s2.id!==sec.id){ sec.dayTimes.forEach(dt=>{ s2.dayTimes.forEach(dt2=>{ if(dt.day!==dt2.day) return; const a=overlapSlots(dt.start,dt.end,sec.type==='Lab'); const b=overlapSlots(dt2.start,dt2.end,s2.type==='Lab'); if(a.some(x=>b.includes(x))) conflicts.push(s2); }); }); }}); return conflicts; }
    function trySelect(sec){ if(state.selected.has(sec.id)){ alert('Already selected: '+sec.code+' '+sec.section); return;} const same=Array.from(state.selected.values()).some(s=>s.code===sec.code); if(same){ alert('Already selected a section for '+sec.code+'. Remove first.'); return;} const conflicts=hasConflict(sec); if(conflicts.length){ alert('Time conflict with:\n'+conflicts.map(c=>c.code+' '+c.section).join('\n')); return;} state.selected.set(sec.id,sec); persistSelection(); renderSelected(); refreshResults(); }
    function removeSelection(id){ state.selected.delete(id); persistSelection(); renderSelected(); refreshResults(); }

    function refreshResults(){ const results=document.getElementById('results'); if(!results) return; const list=state.all.filter(passFilters); const meta=document.getElementById('resultsMeta'); if(meta) meta.textContent=`${list.length} matching sections`; const taken=selectedCourseCodes(); results.innerHTML=''; list.slice(0,250).forEach(sec=>{ if(taken.has(sec.code) && !state.selected.has(sec.id)) return; const color=hashColor(sec.code); const card=document.createElement('div'); card.className='card'; card.innerHTML=`<div class="title" style="color:${color}">${sec.code} — ${sec.title}</div><div class="small">Section: <span class="badge">${sec.section}</span> Program: <span class="badge">${sec.program}</span> Batch: <span class="badge">${sec.batch}</span> Credits: <span class="badge">${sec.credits}</span> <span class="badge">${sec.type}</span></div><div class="small" style="margin-top:6px">${sec.dayTimes.map(dt=>`${dt.day} ${formatRange(dt.start,dt.end)}`).join(' • ')}</div><div class="small muted" style="margin-top:4px">${(sec.teachers||[]).join(', ')}</div><div class="actions"><button class="btn primary">${state.selected.has(sec.id)?'Selected':'Add'}</button><button class="btn" title="Locate">Locate</button></div>`; const addBtn=card.querySelector('.btn.primary'); addBtn.disabled=state.selected.has(sec.id); addBtn.addEventListener('click',()=> trySelect(sec)); card.querySelector('.btn:nth-child(2)').addEventListener('click',()=> scrollToFirstCell(sec)); card.addEventListener('mouseenter',()=> highlightOtherDay(sec, sec.dayTimes[0]?.day)); card.addEventListener('mouseleave', clearGlow); results.appendChild(card); }); updateOptionCounts(); }

    // Persistence
    const LS_KEY='gub_sem_planner_selection';
    function persistSelection(){ localStorage.setItem(LS_KEY, JSON.stringify(Array.from(state.selected.keys()))); }
    function loadPersisted(){ try{ const ids=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); ids.forEach(id=>{ const sec=state.allMap.get(id); if(sec) state.selected.set(id,sec); }); }catch{} }

    function exportSelected(){ const payload=Array.from(state.selected.values()).map(s=>({ id:s.id, code:s.code, title:s.title, section:s.section, program:s.program, batch:s.batch, credits:s.credits, type:s.type, dayTimes:s.dayTimes.map(dt=>({day:dt.day,time:formatRange(dt.start,dt.end),room:dt.room,building:dt.building})) })); const blob=new Blob([JSON.stringify({generatedAt:new Date().toISOString(), selections:payload},null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='selected-courses.json'; a.click(); URL.revokeObjectURL(a.href); }

    function scrollToFirstCell(sec){ const dt=sec.dayTimes[0]; if(!dt) return; const slots=overlapSlots(dt.start,dt.end,sec.type==='Lab'); const sidx=slots[0]; const el=document.querySelector(`.selected-list[data-day="${dt.day}"][data-slot="${sidx}"]`); if(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); el.parentElement.style.outline='2px solid var(--accent)'; setTimeout(()=> el.parentElement.style.outline='none',1200); } }

    // Modal controls
    const modal=document.getElementById('courseModal');
    function openModal(){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; }
    function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); document.body.style.overflow=''; closeAllMenus(); }

    async function init(){ try{ const res=await fetch('ClassRoutine-DM.json',{cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status); const raw=await res.json(); const norm=Array.isArray(raw)? raw.map(normalize).filter(Boolean):[]; const map=new Map(); norm.forEach(s=>{ if(!map.has(s.id)) map.set(s.id,s); }); state.all=Array.from(map.values()); state.allMap=map; fillOptions('programFilter', uniq(state.all.map(s=>s.program).filter(Boolean))); fillOptions('batchFilter', uniq(state.all.map(s=>s.batch).filter(Boolean))); buildOfferedIndex(); renderTable(); loadPersisted(); renderSelected(); refreshResults(); document.getElementById('dataMeta').textContent=`${state.all.length} sections loaded`; }catch(err){ document.getElementById('loadError').classList.remove('hidden'); document.getElementById('dataMeta').textContent='Load error'; console.error(err); }
      document.getElementById('applyFilters')?.addEventListener('click', applyFiltersFromUI); document.getElementById('resetFilters')?.addEventListener('click', ()=>{ ['programFilter','batchFilter','typeFilter','dayFilter','codeFilter','titleFilter'].forEach(id=>{ const el=document.getElementById(id); if(el){ if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; }}); applyFiltersFromUI(); }); document.getElementById('clearSelection')?.addEventListener('click', ()=>{ if(confirm('Clear all selected sections?')){ state.selected.clear(); persistSelection(); renderSelected(); refreshResults(); }}); document.getElementById('exportSelection')?.addEventListener('click', exportSelected); document.getElementById('openFinder')?.addEventListener('click', ()=>{ openModal(); setTimeout(()=> document.getElementById('codeFilter')?.focus(),50); }); document.getElementById('openFinder2')?.addEventListener('click', ()=>{ openModal(); setTimeout(()=> document.getElementById('codeFilter')?.focus(),50); }); document.getElementById('closeFinder')?.addEventListener('click', closeModal); modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); }); document.addEventListener('keydown', e=>{ if(e.key==='Escape') { if(modal.classList.contains('open')) closeModal(); else closeAllMenus(); } }); }

    function uniq(arr){ return Array.from(new Set(arr)).sort(); }
    function fillOptions(id, arr){ const sel=document.getElementById(id); if(!sel) return; arr.forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; sel.appendChild(o); }); }

    document.addEventListener('click', e=>{ const card=e.target.closest('.card'); if(card && e.target.classList.contains('card')){ const t=card.querySelector('.btn.primary'); if(t && !t.disabled) t.click(); }});

    window.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>

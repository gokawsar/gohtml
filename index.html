<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GUB | Semester Planner</title>
  <style>
    :root{
      --bg:#0e1116; --panel:#151a22; --muted:#8ba0b3; --text:#e5edf5; --accent:#50b5ff; --danger:#ff6b6b; --ok:#38d39f; --chip:#233142;
      --grid-border:#2a3442; --slot-bg:#10151c; --break-bg:#0b1118; --offered-chip:#1b2531;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Roboto,system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:14px 18px;border-bottom:1px solid var(--grid-border);display:flex;align-items:center;gap:24px;justify-content:space-between;background:linear-gradient(180deg,#0f141c,#0c1016)}
    header .left{display:flex;flex-direction:column;min-width:240px}
    header .center{flex:1;text-align:center}
    header .right{min-width:280px;display:flex;flex-direction:column;align-items:flex-end;gap:4px}
    header h1{margin:0;font-size:18px;font-weight:600;letter-spacing:.2px}
    header .meta{font-size:12px;color:var(--muted)}

    .layout{display:grid;grid-template-columns:360px 1fr;gap:14px;padding:14px}

    /* Sidebar */
    .panel{background:var(--panel);border:1px solid var(--grid-border);border-radius:10px;overflow:hidden;display:flex;flex-direction:column;min-height:80vh}
    .panel h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--grid-border);font-size:14px;font-weight:600}
    .panel .section{padding:12px 14px;border-bottom:1px dashed var(--grid-border)}
    .panel label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .panel input,.panel select{width:100%;padding:8px 9px;border-radius:8px;border:1px solid var(--grid-border);background:#0f141b;color:var(--text)}
    .panel .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .controls{display:flex;gap:8px;margin-top:8px}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid var(--grid-border);background:#0f141b;color:var(--text);cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:#04131f;font-weight:600}
    .btn.ghost{background:transparent}

    .results{flex:1;overflow:auto;padding:8px 12px}
    .card{border:1px solid var(--grid-border);background:#0f141b;border-radius:10px;padding:10px;margin-bottom:10px}
    .card .title{font-size:14px;font-weight:600;margin-bottom:6px}
    .badge{display:inline-block;font-size:11px;padding:2px 6px;border-radius:999px;background:var(--chip);color:#b8c7d6;margin-right:6px;border:1px solid #2a3a4a}
    .small{font-size:12px;color:var(--muted)}
    .card .actions{display:flex;gap:8px;margin-top:8px}

    .credits{padding:10px 14px;border-top:1px solid var(--grid-border);display:flex;align-items:center;justify-content:space-between}
    .credits strong{font-size:14px}

    /* Scheduler */
    .scheduler{background:var(--panel);border:1px solid var(--grid-border);border-radius:10px;overflow:visible}
    .legend{display:flex;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--grid-border)}
    .legend .dot{width:10px;height:10px;border-radius:50%}

    table{width:100%;border-collapse:collapse;table-layout:fixed}
    thead th{position:sticky;top:0;background:#0f141b;z-index:2}
    th,td{border:1px solid var(--grid-border);padding:8px;vertical-align:top}
    th{font-size:12px;color:#c9d7e6}
    td{background:var(--slot-bg)}
    tr.break-row td{background:var(--break-bg);text-align:center;color:var(--muted);font-weight:600}

    /* Cell content */
    .cell{display:flex;flex-direction:column;gap:6px}
    .selected-list{display:flex;flex-direction:column;gap:6px}
    .selected{border-left:4px solid var(--accent);background:#0e1520;padding:6px;border-radius:8px}
    .selected .head{display:flex;justify-content:space-between;gap:8px;font-size:12px}
    .selected .sub{font-size:11px;color:var(--muted)}
    .remove{cursor:pointer;background:transparent;border:1px solid #3a4657;color:#c9d7e6;border-radius:6px;padding:2px 6px;font-size:11px}

    /* Dropdown options menu for offered sections */
    .options{position:relative;margin-top:6px}
    .options-btn{width:100%;padding:4px 6px;font-size:11px;background:#12202c;color:#cfe3f5;border:1px solid #203040;border-radius:6px;cursor:pointer;text-align:left}
    .options-btn:disabled{opacity:.4;cursor:not-allowed}
    .options.open .options-btn{background:var(--accent);color:#04131f;border-color:var(--accent)}
    .options-menu{position:absolute;z-index:30;top:100%;left:0;margin-top:4px;min-width:260px;max-width:340px;max-height:280px;overflow:auto;background:#0f141b;border:1px solid #264051;box-shadow:0 6px 24px -8px rgba(0,0,0,.6),0 2px 6px -2px rgba(0,0,0,.5);border-radius:10px;padding:4px;display:none}
    .options.open .options-menu{display:block}
    .options-menu.drop-up{top:auto;bottom:100%;margin-top:0;margin-bottom:4px}
    .options-menu.align-right{left:auto;right:0}
    .option-item{display:flex;gap:10px;padding:6px 8px;border-radius:8px;cursor:pointer;font-size:11px;line-height:1.25;outline:none}
    .option-item:hover,.option-item:focus{background:#162532}
    .option-dot{width:10px;height:10px;border-radius:50%;margin-top:5px;flex-shrink:0}
    .option-title{font-weight:600;font-size:11px}
    .option-meta{font-size:10px;color:var(--muted);margin-top:2px}
    .glow{box-shadow:0 0 0 2px #50b5ff66,0 0 0 4px #50b5ff22;border-radius:6px}

    /* Compact summary grids */
    .summary-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}
    .summary-item{border:1px solid var(--grid-border);background:#0f141b;border-radius:8px;padding:8px}
    .summary-item .title{font-size:12px;font-weight:600}
    .summary-item .meta{font-size:11px;color:var(--muted)}

    /* Header summary area */
    .head-status{display:flex;flex-direction:column;align-items:flex-end;gap:6px;max-width:46%}
    #headerSummary{display:flex;flex-direction:column;gap:4px;font-size:11px;text-align:right}
    #headerSummary .sel-line{display:flex;flex-wrap:wrap;gap:4px;justify-content:flex-end}
    #headerSummary .label{font-weight:600;color:var(--accent)}
    .chip-mini{display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border-radius:999px;background:#14202b;border:1px solid #223445;font-size:10px;color:#cfe3f5;margin:2px 3px 0 0;line-height:1.1}
    .chip-mini sup{font-size:9px;color:var(--muted);margin-left:2px}

    @media (max-width: 1100px){
      .layout{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="left">
      <h1 style="margin:0;font-size:18px;font-weight:600;letter-spacing:.2px">Green University of Bangladesh — Semester Planner</h1>
      <div class="meta">Standard time slots: 08:30–10:00 | 10:00–11:30 | 11:30–13:00 | Break | 13:30–15:00 | 15:00–16:30</div>
    </div>
    <div class="center" id="statsWidget">
      <div class="stats-widget" id="statsContent">
        <div class="stat"><strong>0</strong><span class="label">Credits</span></div>
        <div class="stat"><strong>0</strong><span class="label">Theory</span></div>
        <div class="stat"><strong>0</strong><span class="label">Lab</span></div>
        <div class="stat"><strong>0</strong><span class="label">Courses</span></div>
      </div>
    </div>
    <div class="right">
      <div class="meta" id="dataMeta">Loading courses…</div>
      <div id="headerSummary"><div class="muted" style="font-size:11px">No selection</div></div>
    </div>
  </header>

  <div class="layout">
    <!-- Left: selection & filters -->
    <aside class="panel" id="selectionPanel">
      <h2>Find & Select Courses</h2>

      <div class="section">
        <div class="row">
          <div>
            <label for="programFilter">Program</label>
            <select id="programFilter"><option value="">All</option></select>
          </div>
          <div>
            <label for="batchFilter">Batch</label>
            <select id="batchFilter"><option value="">All</option></select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label for="typeFilter">Type</label>
            <select id="typeFilter">
              <option value="">All</option>
              <option value="Theory">Theory</option>
              <option value="Lab">Lab</option>
            </select>
          </div>
          <div>
            <label for="dayFilter">Day</label>
            <select id="dayFilter">
              <option value="">Any</option>
              <option>Sat</option>
              <option>Sun</option>
              <option>Mon</option>
              <option>Tue</option>
              <option>Wed</option>
              <option>Thu</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <div>
            <label for="codeFilter">Course code</label>
            <input id="codeFilter" placeholder="e.g., CSE 211" />
          </div>
          <div>
            <label for="titleFilter">Title/Teacher</label>
            <input id="titleFilter" placeholder="title or teacher" />
          </div>
        </div>
        <div class="controls">
          <button class="btn primary" id="applyFilters">Apply</button>
          <button class="btn ghost" id="resetFilters">Reset</button>
        </div>
        <div class="notice" style="margin-top:8px">
          Tip: Click on a course card or any chip inside a slot to add that section. Conflicts will be alerted.
        </div>
      </div>

      <div class="section">
        <div class="small muted" id="resultsMeta">0 matching sections</div>
        <div class="results" id="results"></div>
      </div>

      <!-- New: compact grouped selection summary -->
      <div class="section" id="summarySection">
        <h3>Selected summary</h3>
        <div class="small muted" id="summaryMeta">No courses selected</div>
        <div class="small" style="margin:6px 0 4px">Theory</div>
        <div class="summary-grid" id="summaryTheory"></div>
        <div class="small" style="margin:8px 0 4px">Lab</div>
        <div class="summary-grid" id="summaryLab"></div>
      </div>

      <div class="credits">
        <strong>Assigned credits: <span id="creditCount">0</span></strong>
        <div style="display:flex;gap:8px">
          <button class="btn" id="exportSelection">Export</button>
          <button class="btn" id="clearSelection">Clear</button>
        </div>
      </div>
    </aside>

    <!-- Right: Scheduler -->
    <main class="scheduler">
      <div class="legend">
        <div class="dot" style="background: var(--accent)"></div>
        <span class="small">Selected</span>
        <div class="dot" style="background: var(--offered-chip);margin-left:12px"></div>
        <span class="small">Offered (click "Options" to view)</span>
      </div>
      <div class="error hidden" id="loadError">Failed to load ClassRoutine-DM.json. Please serve this folder over HTTP (e.g., Live Server) and ensure the JSON file is valid.</div>
      <div class="table-wrap">
        <table id="scheduleTable"></table>
      </div>
    </main>
  </div>

  <script>
  (function(){
    // ===================== Constants & State =====================
    const DAYS = ['Sat','Sun','Mon','Tue','Wed','Thu'];
    const SLOT_DEFS = [
      { key:'S1', label:'08:30 AM - 10:00 AM', start:'08:30', end:'10:00' },
      { key:'S2', label:'10:00 AM - 11:30 AM', start:'10:00', end:'11:30' },
      { key:'S3', label:'11:30 AM - 01:00 PM', start:'11:30', end:'13:00' },
      { key:'BREAK', label:'Break', isBreak:true, start:'13:00', end:'13:30' },
      { key:'S4', label:'01:30 PM - 03:00 PM', start:'13:30', end:'15:00' },
      { key:'S5', label:'03:00 PM - 04:30 PM', start:'15:00', end:'16:30' }
    ];
    const state = { all:[], allMap:new Map(), offeredIndex:{}, selected:new Map(), selectedSlots:{}, filters:{program:'',batch:'',type:'',day:'',code:'',text:''} };
    let glowTargets = [];

    // ===================== Utilities =====================
    function toMinutes(hhmm){ if(!hhmm) return null; let s=hhmm.trim(); const ampmMatch=s.match(/([0-9]{1,2})[:\. ]?([0-9]{2})?\s*:?(AM|PM)/i); if(ampmMatch){ let h=parseInt(ampmMatch[1],10), m=parseInt(ampmMatch[2]||'0',10); const ap=ampmMatch[3].toUpperCase(); if(ap==='PM'&&h!==12) h+=12; if(ap==='AM'&&h===12) h=0; return h*60+m; } const m2=s.match(/^(\d{1,2}):(\d{2})$/); if(m2) return parseInt(m2[1],10)*60+parseInt(m2[2],10); return null; }
    function parseRange(range){ if(!range||typeof range!=='string') return null; const parts=range.split('-'); if(parts.length<2) return null; const start=toMinutes(parts[0].replace(/\s+/g,'').replace(/\./g,':')); const end=toMinutes(parts[1].replace(/\s+/g,'').replace(/\./g,':')); if(start==null||end==null) return null; return {start,end}; }
    function capDay(d){ if(!d) return ''; const s=d.trim(); return s.charAt(0).toUpperCase()+s.slice(1,3).toLowerCase(); }
    function hashColor(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0;} const hue=Math.abs(h)%360; return `hsl(${hue} 70% 45%)`; }
    function toHHMM(m){ const h=Math.floor(m/60), mm=m%60; const ap=h>=12?'PM':'AM'; const h12=((h+11)%12)+1; return `${String(h12).padStart(2,'0')}:${String(mm).padStart(2,'0')} ${ap}`; }
    function formatRange(s,e){ return toHHMM(s)+' - '+toHHMM(e); }
    function overlapSlots(start,end,isLab){ const idxs=[]; SLOT_DEFS.forEach((s,idx)=>{ if(s.isBreak) return; const sm=toMinutes(s.start), em=toMinutes(s.end); const oStart=Math.max(start,sm); const oEnd=Math.min(end,em); if(Math.max(0,oEnd-oStart)>=30) idxs.push(idx); }); if(isLab && idxs.length===1){ const duration=end-start; if(duration>=110){ const i=idxs[0]; if(i+1<SLOT_DEFS.length) idxs.push(i+1); } } return Array.from(new Set(idxs)).sort((a,b)=>a-b); }

    // ===================== Normalization =====================
    function normalize(raw){ try{ const title=raw.Title?.trim(); const formal=raw['FormalCode']?.toString().trim(); const section=raw['SectionName']?.toString().trim(); const credits=Number(raw.Credits); if(!title||!formal||!section||!Number.isFinite(credits)) return null; const type=/(lab)/i.test(raw.GradeSheetTemplate||'')?'Lab':'Theory'; const dayTimes=[]; const d1=capDay(raw.Day1||''); const t1=raw['Time1 (On Day 1)']?.trim(); if(d1&&t1&&t1!=='-'){ const r1=parseRange(t1); if(r1) dayTimes.push({day:d1,start:r1.start,end:r1.end,room:(raw['Room1 (On Day 1)']||'').trim(),building:(raw['Building1 (On Day 1)']||'').trim(),teacher:(raw['Teacher1 (On Day 1)']||'').trim()}); } if(type==='Theory'){ const d2=capDay(raw.Day2||''); const t2=raw['Time2 (On Day 2)']?.trim(); if(d2&&t2&&t2!=='-'){ const r2=parseRange(t2); if(r2) dayTimes.push({day:d2,start:r2.start,end:r2.end,room:(raw['Room2 (On Day 1)']||raw['Room2 (On Day 2)']||'').trim(),building:(raw['Building2 (On Day 2)']||'').trim(),teacher:(raw['Teacher2 (On Day 2)']||raw['Teacher2 (On Day 1)']||'').trim()}); }} if(dayTimes.length===0) return null; const code=formal.split(/\s*-/)[0].trim(); const id=`${formal}|${section}`; return {id,code,title,section,program:raw.Program?.trim()||'',batch:raw.Batch?.trim()||'',credits,type,dayTimes,teachers:Array.from(new Set([raw['Teacher1 (On Day 1)'],raw['Teacher2 (On Day 2)']].filter(Boolean))).map(s=>s?.toString().trim())}; }catch{return null;} }

    function buildOfferedIndex(){ state.offeredIndex={}; DAYS.forEach(d=> state.offeredIndex[d]=SLOT_DEFS.map(()=>[])); state.all.forEach(sec=>{ sec.dayTimes.forEach(dt=>{ const slots=overlapSlots(dt.start,dt.end,sec.type==='Lab'); slots.forEach(sidx=>{ if(!state.offeredIndex[dt.day]) state.offeredIndex[dt.day]=SLOT_DEFS.map(()=>[]); state.offeredIndex[dt.day][sidx].push(sec.id); }); }); }); }

    // ===================== Selection helpers =====================
    function isCourseSelected(code){ for(const s of state.selected.values()){ if(s.code===code) return true; } return false; }
    function hasConflict(sec){ const conflicts=[]; state.selected.forEach(s2=>{ if(s2.id!==sec.id){ sec.dayTimes.forEach(dt=>{ s2.dayTimes.forEach(dt2=>{ if(dt.day!==dt2.day) return; const a=overlapSlots(dt.start,dt.end,sec.type==='Lab'); const b=overlapSlots(dt2.start,dt2.end,s2.type==='Lab'); if(a.some(x=>b.includes(x))) conflicts.push(s2); }); }); }}); return conflicts; }
    function trySelect(sec){ if(state.selected.has(sec.id)){ alert('Already selected: '+sec.code+' '+sec.section); return; } if(isCourseSelected(sec.code)){ alert('You already selected a section of '+sec.code); return; } const conflicts=hasConflict(sec); if(conflicts.length){ alert('Time conflict with:\n'+conflicts.map(c=>`${c.code} ${c.section}`).join('\n')); return; } state.selected.set(sec.id,sec); persistSelection(); renderSelected(); refreshResults(); }
    function removeSelection(id){ state.selected.delete(id); persistSelection(); renderSelected(); refreshResults(); }

    // ===================== Rendering =====================
    function chipTitle(sec, day){ const dt=sec.dayTimes.find(x=>x.day===day); const timeHere=dt?formatRange(dt.start,dt.end):''; const other=sec.dayTimes.find(x=>x.day!==day); const otherTxt=other?`${other.day} ${formatRange(other.start,other.end)}`:(sec.type==='Lab'?'Lab (single day)':''); return `${sec.code} ${sec.section}\n${sec.title}\nHere: ${day} ${timeHere}${otherTxt?`\nOther: ${otherTxt}`:''}`.trim(); }

    function highlightOtherDay(sec, hoveredDay){ clearGlow(); const here=sec.dayTimes.find(x=>x.day===hoveredDay); if(here){ overlapSlots(here.start,here.end,sec.type==='Lab').forEach(sidx=>{ const el=document.querySelector(`.selected-list[data-day="${hoveredDay}"][data-slot="${sidx}"]`); if(el){ el.classList.add('glow'); glowTargets.push(el);} }); } if(sec.type==='Theory'){ const other=sec.dayTimes.find(x=>x.day!==hoveredDay); if(other){ overlapSlots(other.start,other.end,false).forEach(sidx=>{ const el=document.querySelector(`.selected-list[data-day="${other.day}"][data-slot="${sidx}"]`); if(el){ el.classList.add('glow'); glowTargets.push(el);} }); } } }
    function clearGlow(){ glowTargets.forEach(el=>el.classList.remove('glow')); glowTargets=[]; }

    function buildOptionsMenu(menu, day, sidx){ menu.innerHTML=''; const ids=(state.offeredIndex[day]?.[sidx])||[]; const filtered=ids.filter(id=>{ const sec=state.allMap.get(id); return sec && !isCourseSelected(sec.code); }); if(filtered.length===0){ const empty=document.createElement('div'); empty.className='option-meta'; empty.style.padding='8px'; empty.textContent='No sections available'; menu.appendChild(empty); return; } filtered.slice(0,300).forEach((id,idx)=>{ const sec=state.allMap.get(id); if(!sec) return; const color=hashColor(sec.code); const item=document.createElement('div'); item.className='option-item'; item.tabIndex=0; item.setAttribute('role','button'); item.title=chipTitle(sec,day); const dot=document.createElement('div'); dot.className='option-dot'; dot.style.background=color; const body=document.createElement('div'); body.className='option-body'; const title=document.createElement('div'); title.className='option-title'; title.textContent=`${sec.code} ${sec.section}`; const hereDT=sec.dayTimes.find(x=>x.day===day); const other=sec.dayTimes.find(x=>x.day!==day); const meta=document.createElement('div'); meta.className='option-meta'; const hereStr=hereDT?`${day} ${formatRange(hereDT.start,hereDT.end)}`:''; const otherStr=other?`Other: ${other.day} ${formatRange(other.start,other.end)}`:(sec.type==='Lab'?'Lab • single day':''); meta.textContent=`${sec.title} • ${hereStr}${otherStr?` • ${otherStr}`:''}`; body.appendChild(title); body.appendChild(meta); item.appendChild(dot); item.appendChild(body); const glow=()=>highlightOtherDay(sec,day); item.addEventListener('mouseenter',glow); item.addEventListener('mouseleave',clearGlow); item.addEventListener('focus',glow); item.addEventListener('blur',clearGlow); item.addEventListener('click',()=>{ trySelect(sec); closeAllMenus(); }); item.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); trySelect(sec); closeAllMenus(); } else if(e.key==='Escape'){ closeAllMenus(); } else if(e.key==='ArrowDown'){ e.preventDefault(); (item.nextElementSibling||menu.firstElementChild)?.focus(); } else if(e.key==='ArrowUp'){ e.preventDefault(); (item.previousElementSibling||menu.lastElementChild)?.focus(); } }); menu.appendChild(item); }); }

    function positionOptionsMenu(container, menu){ menu.classList.remove('drop-up','align-right'); const rect=menu.getBoundingClientRect(); const vw=innerWidth, vh=innerHeight; if(rect.right>vw-12) menu.classList.add('align-right'); if(rect.bottom>vh-12) menu.classList.add('drop-up'); }
    function closeAllMenus(){ document.querySelectorAll('.options.open').forEach(o=>o.classList.remove('open')); clearGlow(); }

    function renderTable(){ const table=document.getElementById('scheduleTable'); const thead=document.createElement('thead'); const trh=document.createElement('tr'); const thDay=document.createElement('th'); thDay.textContent='Day'; trh.appendChild(thDay); SLOT_DEFS.forEach(slot=>{ const th=document.createElement('th'); th.textContent=slot.label; trh.appendChild(th); }); thead.appendChild(trh); const tbody=document.createElement('tbody'); DAYS.forEach(day=>{ const tr=document.createElement('tr'); const th=document.createElement('th'); th.textContent=day; tr.appendChild(th); SLOT_DEFS.forEach((slot,sidx)=>{ const td=document.createElement('td'); if(slot.isBreak){ td.className='break-cell'; td.textContent='Break'; tr.appendChild(td); return; } const cell=document.createElement('div'); cell.className='cell'; const selectedList=document.createElement('div'); selectedList.className='selected-list'; selectedList.dataset.day=day; selectedList.dataset.slot=sidx; const options=document.createElement('div'); options.className='options'; options.dataset.day=day; options.dataset.slot=sidx; const btn=document.createElement('button'); btn.className='options-btn'; const baseIds=(state.offeredIndex[day]?.[sidx])||[]; const avail=baseIds.filter(id=>{ const s=state.allMap.get(id); return s && !isCourseSelected(s.code); }); btn.textContent=`Options${avail.length?` (${avail.length})`:''}`; btn.disabled=avail.length===0; const menu=document.createElement('div'); menu.className='options-menu'; options.appendChild(btn); options.appendChild(menu); btn.addEventListener('click',e=>{ e.stopPropagation(); const willOpen=!options.classList.contains('open'); closeAllMenus(); if(willOpen){ options.classList.add('open'); buildOptionsMenu(menu,day,sidx); positionOptionsMenu(options,menu); setTimeout(()=>menu.querySelector('.option-item')?.focus(),0); } }); cell.appendChild(selectedList); cell.appendChild(options); td.appendChild(cell); tr.appendChild(td); }); tbody.appendChild(tr); }); table.innerHTML=''; table.appendChild(thead); table.appendChild(tbody); document.addEventListener('click',e=>{ if(!e.target.closest('.options')) closeAllMenus(); }); addEventListener('resize',closeAllMenus); }

    function recalcAllOptionCounts(){ document.querySelectorAll('.options').forEach(opt=>{ const day=opt.dataset.day; const slot=Number(opt.dataset.slot); const baseIds=(state.offeredIndex[day]?.[slot])||[]; const available=baseIds.filter(id=>{ const s=state.allMap.get(id); return s && !isCourseSelected(s.code); }); const btn=opt.querySelector('.options-btn'); if(btn){ btn.textContent=`Options${available.length?` (${available.length})`:''}`; btn.disabled=available.length===0; } if(available.length===0 && opt.classList.contains('open')) opt.classList.remove('open'); }); }

    function renderSelected(){ state.selectedSlots={}; DAYS.forEach(d=> state.selectedSlots[d]=SLOT_DEFS.map(()=>null)); document.querySelectorAll('.selected-list').forEach(el=> el.innerHTML=''); state.selected.forEach(sec=>{ sec.dayTimes.forEach(dt=>{ const slots=overlapSlots(dt.start,dt.end,sec.type==='Lab'); slots.forEach(sidx=>{ const cell=document.querySelector(`.selected-list[data-day="${dt.day}"][data-slot="${sidx}"]`); if(!cell) return; state.selectedSlots[dt.day][sidx]=state.selectedSlots[dt.day][sidx]||[]; state.selectedSlots[dt.day][sidx].push(sec.id); const block=document.createElement('div'); block.className='selected'; block.style.borderLeftColor=hashColor(sec.code); block.innerHTML=`<div class='head'><div><strong>${sec.code}</strong> ${sec.section}</div><button class='remove' title='Remove'>Remove</button></div><div class='sub'>${sec.title}</div><div class='sub'>${dt.day} ${formatRange(dt.start,dt.end)}</div>`; block.querySelector('.remove').addEventListener('click',()=> removeSelection(sec.id)); cell.appendChild(block); }); }); }); let credits=0; const theory=[],lab=[]; state.selected.forEach(sec=>{ credits+=Number(sec.credits)||0; (sec.type==='Lab'?lab:theory).push(sec); }); document.getElementById('creditCount').textContent=credits; renderSummary(theory,lab); updateHeaderSummary(theory,lab,credits); recalcAllOptionCounts(); }

    function renderSummary(theory,lab){ const tEl=document.getElementById('summaryTheory'); const lEl=document.getElementById('summaryLab'); const mEl=document.getElementById('summaryMeta'); if(!tEl||!lEl||!mEl) return; const make=s=>`<div class='summary-item'><div class='title'>${s.code}</div><div class='meta'>${s.title}</div><div class='meta'>${s.credits} cr • ${s.section}</div></div>`; tEl.innerHTML=theory.map(make).join(''); lEl.innerHTML=lab.map(make).join(''); mEl.textContent=(theory.length+lab.length)?`${theory.length} theory • ${lab.length} lab`:'No courses selected'; }
    function updateHeaderStats(theory,lab,credits){ const el=document.getElementById('statsContent'); if(!el) return; el.innerHTML=`<div class='stat'><strong>${credits}</strong><span class='label'>Credits</span></div><div class='stat'><strong>${theory.length}</strong><span class='label'>Theory</span></div><div class='stat'><strong>${lab.length}</strong><span class='label'>Lab</span></div><div class='stat'><strong>${theory.length+lab.length}</strong><span class='label'>Courses</span></div>`; }
    function updateHeaderSummary(theory,lab,credits){ const el=document.getElementById('headerSummary'); if(!el) return; if(!theory.length && !lab.length){ el.innerHTML='<div class="muted" style="font-size:11px">No selection</div>'; updateHeaderStats([],[],0); return; } const chip=s=>`<span class=\"chip-mini\" title=\"${s.title.replace(/\"/g,'&quot;')}\">${s.code}<sup>${s.credits}</sup></span>`; el.innerHTML=`${theory.length?`<div class='sel-line'><span class='label'>T:</span>${theory.map(chip).join('')}</div>`:''}${lab.length?`<div class='sel-line'><span class='label'>L:</span>${lab.map(chip).join('')}</div>`:''}`; updateHeaderStats(theory,lab,credits); }

    // ===================== Filters & Results =====================
    function passFilters(sec){ const f=state.filters; if(f.program && sec.program!==f.program) return false; if(f.batch && sec.batch!==f.batch) return false; if(f.type && sec.type!==f.type) return false; if(f.day && !sec.dayTimes.some(dt=>dt.day===f.day)) return false; if(f.code && !(sec.code.toLowerCase().includes(f.code)||sec.id.toLowerCase().includes(f.code))) return false; if(f.text){ const t=[sec.title,...(sec.teachers||[])].join(' ').toLowerCase(); if(!t.includes(f.text)) return false; } return true; }
    function applyFiltersFromUI(){ state.filters.program=document.getElementById('programFilter').value; state.filters.batch=document.getElementById('batchFilter').value; state.filters.type=document.getElementById('typeFilter').value; state.filters.day=document.getElementById('dayFilter').value; state.filters.code=document.getElementById('codeFilter').value.trim().toLowerCase(); state.filters.text=document.getElementById('titleFilter').value.trim().toLowerCase(); refreshResults(); }
    function refreshResults(){ const results=document.getElementById('results'); const list=state.all.filter(passFilters); document.getElementById('resultsMeta').textContent=`${list.length} matching sections`; results.innerHTML=''; list.slice(0,200).forEach(sec=>{ const card=document.createElement('div'); card.className='card'; const color=hashColor(sec.code); card.innerHTML=`<div class='title' style='color:${color}'>${sec.code} — ${sec.title}</div><div class='small'>Section: <span class='badge'>${sec.section}</span> Program: <span class='badge'>${sec.program}</span> Batch: <span class='badge'>${sec.batch}</span> Credits: <span class='badge'>${sec.credits}</span> <span class='badge'>${sec.type}</span></div><div class='small' style='margin-top:6px'>${sec.dayTimes.map(dt=>`${dt.day} ${formatRange(dt.start,dt.end)}`).join(' • ')}</div><div class='small muted' style='margin-top:4px'>${(sec.teachers||[]).join(', ')}</div><div class='actions'><button class='btn primary'>${state.selected.has(sec.id)?'Selected':'Add section'}</button><button class='btn' title='Scroll to schedule'>Locate</button></div>`; const addBtn=card.querySelector('.btn.primary'); addBtn.disabled=state.selected.has(sec.id)||isCourseSelected(sec.code); addBtn.addEventListener('click',()=> trySelect(sec)); card.querySelector('.btn:nth-child(2)').addEventListener('click',()=> scrollToFirstCell(sec)); card.addEventListener('mouseenter',()=> highlightOtherDay(sec,sec.dayTimes[0]?.day)); card.addEventListener('mouseleave',clearGlow); results.appendChild(card); }); }
    function scrollToFirstCell(sec){ const dt=sec.dayTimes[0]; if(!dt) return; const sidx=overlapSlots(dt.start,dt.end,sec.type==='Lab')[0]; const el=document.querySelector(`.selected-list[data-day="${dt.day}"][data-slot="${sidx}"]`); if(el){ el.scrollIntoView({behavior:'smooth',block:'center'}); el.parentElement.style.outline='2px solid var(--accent)'; setTimeout(()=> el.parentElement.style.outline='none',1200); }}

    // ===================== Persistence & Export =====================
    const LS_KEY='gub_sem_planner_selection';
    function persistSelection(){ localStorage.setItem(LS_KEY, JSON.stringify(Array.from(state.selected.keys()))); }
    function loadPersisted(){ try{ const ids=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); ids.forEach(id=>{ const sec=state.allMap.get(id); if(sec) state.selected.set(id,sec); }); }catch{} }
    function exportSelected(){ const payload=Array.from(state.selected.values()).map(s=>({id:s.id,code:s.code,title:s.title,section:s.section,program:s.program,batch:s.batch,credits:s.credits,type:s.type,dayTimes:s.dayTimes.map(dt=>({day:dt.day,time:formatRange(dt.start,dt.end),building:dt.building,room:dt.room}))})); const blob=new Blob([JSON.stringify({generatedAt:new Date().toISOString(),selections:payload},null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='selected-courses.json'; a.click(); URL.revokeObjectURL(a.href); }

    // ===================== Init =====================
    async function init(){ try{ const res=await fetch('ClassRoutine-DM.json',{cache:'no-store'}); if(!res.ok) throw new Error('HTTP '+res.status); const raw=await res.json(); const normalized=Array.isArray(raw)?raw.map(normalize).filter(Boolean):[]; const map=new Map(); normalized.forEach(s=>{ if(!map.has(s.id)) map.set(s.id,s); }); state.all=Array.from(map.values()); state.allMap=map; fillOptions('programFilter',uniq(state.all.map(s=>s.program).filter(Boolean))); fillOptions('batchFilter',uniq(state.all.map(s=>s.batch).filter(Boolean))); buildOfferedIndex(); renderTable(); loadPersisted(); renderSelected(); refreshResults(); document.getElementById('dataMeta').textContent=`${state.all.length} sections loaded`; }catch(err){ document.getElementById('loadError').classList.remove('hidden'); document.getElementById('dataMeta').textContent='Load error'; console.error(err); } bindEvents(); }

    function bindEvents(){ document.getElementById('applyFilters').addEventListener('click',applyFiltersFromUI); document.getElementById('resetFilters').addEventListener('click',()=>{ ['programFilter','batchFilter','typeFilter','dayFilter','codeFilter','titleFilter'].forEach(id=>{ const el=document.getElementById(id); if(el){ if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; }}); applyFiltersFromUI(); }); document.getElementById('clearSelection').addEventListener('click',()=>{ if(confirm('Clear all selected sections?')){ state.selected.clear(); persistSelection(); renderSelected(); refreshResults(); }}); document.getElementById('exportSelection').addEventListener('click',exportSelected); document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeAllMenus(); }); document.addEventListener('click',e=>{ const card=e.target.closest('.card'); if(card && e.target.classList.contains('card')){ const t=card.querySelector('.btn.primary'); if(t && !t.disabled) t.click(); } }); }

    function uniq(arr){ return Array.from(new Set(arr)).sort(); }
    function fillOptions(id, arr){ const sel=document.getElementById(id); arr.forEach(v=>{ const o=document.createElement('option'); o.value=o.textContent=v; sel.appendChild(o); }); }

    window.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>

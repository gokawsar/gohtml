<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Routine Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .description {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }
        
        .upload-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .upload-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        input, select, button {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        input[type="file"] {
            flex: 1;
            padding: 10px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .credit-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .credit-control input {
            width: 80px;
        }
        
        .results-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .course-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .course-header {
            background: #ecf0f1;
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .course-title {
            font-weight: bold;
            font-size: 18px;
            color: #2c3e50;
        }
        
        .course-info {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .sections-container {
            display: none;
            padding: 0;
        }
        
        .section-item {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-info {
            flex: 1;
            min-width: 250px;
        }
        
        .section-time {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .section-days {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .section-teacher {
            color: #7f8c8d;
            font-style: italic;
        }
        
        .section-action {
            display: flex;
            gap: 10px;
        }
        
        .btn-add {
            background: #27ae60;
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-add:hover {
            background: #219653;
        }
        
        .btn-remove {
            background: #e74c3c;
            padding: 8px 15px;
            font-size: 14px;
        }
        
        .btn-remove:hover {
            background: #c0392b;
        }
        
        .schedule-section {
            margin-top: 30px;
        }
        
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .credit-info {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .schedule-table th {
            background: #34495e;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .schedule-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #eee;
            height: 80px;
            vertical-align: top;
        }
        
        .time-cell {
            background: #f8f9fa;
            font-weight: bold;
            width: 120px;
        }
        
        .course-slot {
            background: #d6eaf8;
            border-radius: 4px;
            padding: 8px;
            font-size: 14px;
            margin-bottom: 5px;
            cursor: pointer;
        }
        
        .course-slot.conflict {
            background: #f9d6d8;
        }
        
        .no-courses {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }
        
        .conflict-warning {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        @media (max-width: 768px) {
            .schedule-table {
                font-size: 14px;
            }
            
            .course-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .section-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .section-action {
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Class Routine Visualizer</h1>
            <p class="description">Upload your Excel file to visualize and plan your class schedule</p>
        </header>
        
        <div class="main-content">
            <div class="upload-section">
                <div class="upload-box">
                    <input type="file" id="excelFile" accept=".xlsx, .xls">
                    <button id="uploadBtn">Upload</button>
                </div>
                
                <div class="credit-control">
                    <label for="maxCredits">Max Credits:</label>
                    <input type="number" id="maxCredits" min="1" max="30" value="19">
                    <button id="updateCredits">Update</button>
                </div>
            </div>
            
            <div class="conflict-warning" id="conflictWarning"></div>
            
            <div class="results-section" id="resultsContainer">
                <div class="no-courses">Upload an Excel file to view courses</div>
            </div>
            
            <div class="schedule-section">
                <div class="schedule-header">
                    <h2>My Weekly Schedule</h2>
                    <div class="credit-info">Total Credits: <span id="totalCredits">0</span> / <span id="maxCreditsDisplay">19</span></div>
                </div>
                
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Saturday</th>
                            <th>Sunday</th>
                            <th>Monday</th>
                            <th>Tuesday</th>
                            <th>Wednesday</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody">
                        <!-- Schedule will be generated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <footer>
            <p>Class Routine Visualizer - Plan your semester with no time conflicts</p>
        </footer>
    </div>

    <script>
        // Global variables
        let classData = [];
        let selectedCourses = [];
        let maxCredits = 19;
        const timeSlots = [
            "08:30:AM - 10:00:AM",
            "10:00:AM - 11:30:AM",
            "11:30:AM - 01:00:PM",
            "01:30:PM - 03:00:PM",
            "03:00:PM - 04:30:PM"
        ];
        const days = ["Sat", "Sun", "Mon", "Tue", "Wed"];

        // DOM elements
        const excelFileInput = document.getElementById('excelFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const maxCreditsInput = document.getElementById('maxCredits');
        const updateCreditsBtn = document.getElementById('updateCredits');
        const maxCreditsDisplay = document.getElementById('maxCreditsDisplay');
        const resultsContainer = document.getElementById('resultsContainer');
        const scheduleBody = document.getElementById('scheduleBody');
        const totalCreditsEl = document.getElementById('totalCredits');
        const conflictWarning = document.getElementById('conflictWarning');

        // Initialize the application
        function init() {
            // Generate initial schedule
            generateSchedule();
            
            // Set up event listeners
            uploadBtn.addEventListener('click', handleFileUpload);
            updateCreditsBtn.addEventListener('click', updateMaxCredits);
        }

        // Handle file upload
        function handleFileUpload() {
            const file = excelFileInput.files[0];
            if (!file) {
                alert('Please select an Excel file first.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Assuming the first sheet contains the data
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                // Process the data (skip the header row)
                processExcelData(jsonData.slice(1));
            };
            reader.readAsArrayBuffer(file);
        }

        // Process Excel data
        function processExcelData(data) {
            classData = [];
            
            data.forEach(row => {
                if (row.length >= 11) {
                    const course = {
                        formalCode: row[0] || '',
                        title: row[1] || '',
                        sectionName: row[2] || '',
                        day1: row[3] || '',
                        day2: row[4] || '',
                        time1: row[5] || '',
                        time2: row[6] || '',
                        teacher1: row[7] || '',
                        teacher2: row[8] || '',
                        credits: parseFloat(row[10]) || 0,
                        type: (row[1] || '').toLowerCase().includes('lab') ? 'Lab' : 'Theory'
                    };
                    classData.push(course);
                }
            });
            
            displayCourses(classData);
        }

        // Display courses in the results section
        function displayCourses(courses) {
            if (courses.length === 0) {
                resultsContainer.innerHTML = '<div class="no-courses">No courses found in the Excel file</div>';
                return;
            }
            
            // Group courses by title
            const coursesByTitle = {};
            courses.forEach(course => {
                const key = course.formalCode + '|' + course.title;
                if (!coursesByTitle[key]) {
                    coursesByTitle[key] = [];
                }
                coursesByTitle[key].push(course);
            });
            
            // Generate HTML for each course group
            let html = '';
            for (const key in coursesByTitle) {
                const [formalCode, title] = key.split('|');
                const courseSections = coursesByTitle[key];
                
                html += `
                    <div class="course-card">
                        <div class="course-header" onclick="toggleSections(this)">
                            <div class="course-title">${formalCode} - ${title}</div>
                            <div class="course-info">
                                <span>${courseSections.length} sections</span>
                                <span>${courseSections[0].credits} credits</span>
                                <span>${courseSections[0].type}</span>
                            </div>
                        </div>
                        <div class="sections-container">
                `;
                
                courseSections.forEach(section => {
                    const isSelected = selectedCourses.some(c => c.sectionName === section.sectionName);
                    const conflicts = checkTimeConflict(section);
                    
                    html += `
                        <div class="section-item">
                            <div class="section-info">
                                <div class="section-time">${section.time1} ${section.day1} | ${section.time2} ${section.day2}</div>
                                <div class="section-days">Section: ${section.sectionName}</div>
                                <div class="section-teacher">Teachers: ${section.teacher1} ${section.teacher2 ? ', ' + section.teacher2 : ''}</div>
                            </div>
                            <div class="section-action">
                                ${isSelected ? 
                                    `<button class="btn-remove" onclick="removeCourse('${section.sectionName}')">Remove</button>` :
                                    `<button class="btn-add" onclick="addCourse('${section.sectionName}')">Add</button>`
                                }
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            resultsContainer.innerHTML = html;
        }

        // Toggle section visibility
        function toggleSections(element) {
            const sectionsContainer = element.nextElementSibling;
            sectionsContainer.style.display = sectionsContainer.style.display === 'block' ? 'none' : 'block';
        }

        // Add a course to the schedule
        function addCourse(sectionName) {
            const course = classData.find(c => c.sectionName === sectionName);
            if (!course) return;
            
            // Check for time conflicts
            const conflicts = checkTimeConflict(course);
            if (conflicts.length > 0) {
                showConflictWarning(course, conflicts);
                return;
            }
            
            // Check credit limit
            const newTotalCredits = calculateTotalCredits() + course.credits;
            if (newTotalCredits > maxCredits) {
                alert(`You have exceeded the maximum credit limit of ${maxCredits}!`);
                return;
            }
            
            selectedCourses.push(course);
            updateSchedule();
            displayCourses(classData); // Refresh the course list to update buttons
        }

        // Remove a course from the schedule
        function removeCourse(sectionName) {
            selectedCourses = selectedCourses.filter(c => c.sectionName !== sectionName);
            updateSchedule();
            displayCourses(classData); // Refresh the course list to update buttons
        }

        // Check for time conflicts
        function checkTimeConflict(newCourse) {
            const conflicts = [];
            
            for (const course of selectedCourses) {
                // Check day1 and time1 conflict
                if (newCourse.day1 && course.day1 && newCourse.day1 === course.day1 && 
                    newCourse.time1 === course.time1) {
                    conflicts.push(course);
                }
                
                // Check day1 and time2 conflict
                if (newCourse.day1 && course.day2 && newCourse.day1 === course.day2 && 
                    newCourse.time1 === course.time2 && newCourse.time2 !== '-') {
                    conflicts.push(course);
                }
                
                // Check day2 and time1 conflict
                if (newCourse.day2 && course.day1 && newCourse.day2 === course.day1 && 
                    newCourse.time2 === course.time1 && newCourse.time2 !== '-') {
                    conflicts.push(course);
                }
                
                // Check day2 and time2 conflict
                if (newCourse.day2 && course.day2 && newCourse.day2 === course.day2 && 
                    newCourse.time2 === course.time2 && newCourse.time2 !== '-') {
                    conflicts.push(course);
                }
            }
            
            return conflicts;
        }

        // Show conflict warning
        function showConflictWarning(newCourse, conflicts) {
            let conflictText = `This course conflicts with: `;
            conflictText += conflicts.map(c => `${c.formalCode} (${c.sectionName})`).join(', ');
            conflictText += `<br><br>Adding this course will remove the conflicting ones. <button onclick="resolveConflictAndAdd('${newCourse.sectionName}')">Proceed</button>`;
            
            conflictWarning.innerHTML = conflictText;
            conflictWarning.style.display = 'block';
        }

        // Resolve conflict and add course
        function resolveConflictAndAdd(sectionName) {
            const course = classData.find(c => c.sectionName === sectionName);
            if (!course) return;
            
            // Find conflicts
            const conflicts = checkTimeConflict(course);
            
            // Remove conflicting courses
            selectedCourses = selectedCourses.filter(c => !conflicts.some(conflict => conflict.sectionName === c.sectionName));
            
            // Add the new course
            selectedCourses.push(course);
            
            // Update UI
            updateSchedule();
            displayCourses(classData);
            conflictWarning.style.display = 'none';
        }

        // Calculate total credits
        function calculateTotalCredits() {
            return selectedCourses.reduce((total, course) => total + course.credits, 0);
        }

        // Update max credits
        function updateMaxCredits() {
            const newMax = parseInt(maxCreditsInput.value);
            if (isNaN(newMax) || newMax < 1) {
                alert('Please enter a valid number for max credits');
                return;
            }
            
            maxCredits = newMax;
            maxCreditsDisplay.textContent = maxCredits;
            
            // Check if current selection exceeds new limit
            const currentCredits = calculateTotalCredits();
            if (currentCredits > maxCredits) {
                alert(`Your current selection exceeds the new credit limit. Please remove some courses.`);
            }
        }

        // Generate the schedule table
        function generateSchedule() {
            let html = '';
            
            timeSlots.forEach(timeSlot => {
                html += `<tr>`;
                html += `<td class="time-cell">${timeSlot}</td>`;
                
                days.forEach(day => {
                    html += `<td data-day="${day}" data-time="${timeSlot}"></td>`;
                });
                
                html += `</tr>`;
            });
            
            scheduleBody.innerHTML = html;
        }

        // Update the schedule with selected courses
        function updateSchedule() {
            // Clear all cells
            const cells = document.querySelectorAll('#scheduleBody td');
            cells.forEach(cell => {
                if (!cell.classList.contains('time-cell')) {
                    cell.innerHTML = '';
                }
            });
            
            // Add courses to schedule
            selectedCourses.forEach(course => {
                // Add first day/time
                if (course.day1 && course.time1 && course.time1 !== '-') {
                    const cell = document.querySelector(`td[data-day="${course.day1}"][data-time="${course.time1}"]`);
                    if (cell) {
                        cell.innerHTML += `
                            <div class="course-slot" onclick="removeCourse('${course.sectionName}')">
                                ${course.formalCode}<br>
                                ${course.sectionName}<br>
                                ${course.teacher1}
                            </div>
                        `;
                    }
                }
                
                // Add second day/time
                if (course.day2 && course.time2 && course.time2 !== '-') {
                    const cell = document.querySelector(`td[data-day="${course.day2}"][data-time="${course.time2}"]`);
                    if (cell) {
                        cell.innerHTML += `
                            <div class="course-slot" onclick="removeCourse('${course.sectionName}')">
                                ${course.formalCode}<br>
                                ${course.sectionName}<br>
                                ${course.teacher2}
                            </div>
                        `;
                    }
                }
            });
            
            // Update credit count
            totalCreditsEl.textContent = calculateTotalCredits();
        }

        // Initialize the application when the page loads
        window.onload = init;
    </script>
</body>
</html>